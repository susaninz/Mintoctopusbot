"""
–£–ª—É—á—à–µ–Ω–Ω—ã–π GPT —Å–µ—Ä–≤–∏—Å —Å –ø–æ–ª–Ω–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π
"""
import openai
import os
import re
import json
import asyncio
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Tuple, Any
import logging

from bot.constants import GPT_MODEL, GPT_TEMPERATURE, GPT_MAX_TOKENS
from bot.utils.validation import sanitize_user_input

logger = logging.getLogger(__name__)


class GPTService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OpenAI GPT API."""
    
    def __init__(self):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è GPT —Å–µ—Ä–≤–∏—Å–∞.
        
        Raises:
            ValueError: –ï—Å–ª–∏ OPENAI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
        """
        api_key = os.getenv("OPENAI_API_KEY")
        if not api_key:
            raise ValueError("OPENAI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
        
        self.client = openai.OpenAI(api_key=api_key)
        
    async def _retry_gpt_call(self, func, *args, max_retries: int = 3, **kwargs) -> Any:
        """
        Retry wrapper –¥–ª—è GPT API calls —Å exponential backoff.
        
        Args:
            func: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–∑–æ–≤–∞
            max_retries: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
            *args, **kwargs: –ê—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏
            
        Returns:
            –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–∑–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏–∏
            
        Raises:
            Exception: –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã
        """
        for attempt in range(max_retries):
            try:
                return func(*args, **kwargs)  # –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            except openai.RateLimitError as e:
                if attempt == max_retries - 1:
                    logger.error(f"Rate limit exceeded, all retries exhausted: {e}")
                    raise
                wait_time = 2 ** attempt
                logger.warning(f"Rate limited, waiting {wait_time}s (attempt {attempt + 1})")
                await asyncio.sleep(wait_time)
            except (openai.APIConnectionError, openai.APITimeoutError) as e:
                if attempt == max_retries - 1:
                    logger.error(f"API connection error, all retries exhausted: {e}")
                    raise
                wait_time = 2 ** attempt
                logger.warning(f"API connection error, retrying in {wait_time}s (attempt {attempt + 1})")
                await asyncio.sleep(wait_time)
            except openai.APIError as e:
                logger.error(f"OpenAI API error: {e}")
                raise
            except Exception as e:
                logger.error(f"Unexpected error in GPT call: {e}")
                raise
    
    def analyze_master_profile(self, profile_text: str) -> Dict:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∞–Ω–∫–µ—Ç—É –º–∞—Å—Ç–µ—Ä–∞ –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
        
        Args:
            profile_text: –¢–µ–∫—Å—Ç –∞–Ω–∫–µ—Ç—ã –º–∞—Å—Ç–µ—Ä–∞
            
        Returns:
            Dict —Å –∏–∑–≤–ª–µ—á–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π: –∏–º—è, —É—Å–ª—É–≥–∏, —Å–ª–æ—Ç—ã, –ª–æ–∫–∞—Ü–∏–∏
        """
        
        prompt = f"""
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∞–Ω–∫–µ—Ç—É –º–∞—Å—Ç–µ—Ä–∞ –∏ –∏–∑–≤–ª–µ–∫–∏ –∏–∑ –Ω–µ—ë —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.

–ê–Ω–∫–µ—Ç–∞ –º–∞—Å—Ç–µ—Ä–∞:
"{profile_text}"

–ú–Ω–µ –Ω—É–∂–Ω–æ –∏–∑–≤–ª–µ—á—å:
1. –ò–º—è –º–∞—Å—Ç–µ—Ä–∞ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ)
2. –°–ø–∏—Å–æ–∫ —É—Å–ª—É–≥ (–º–∞—Å—Å–∞–∂, —Ä–µ–π–∫–∏, –∏ —Ç.–¥.)
3. –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –¥–∞—Ç—ã, –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è

–í–ê–ñ–ù–û: –ï—Å–ª–∏ –≤ –∞–Ω–∫–µ—Ç–µ –ù–ï —É–∫–∞–∑–∞–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è, –∏—Å–ø–æ–ª—å–∑—É–π "–ë–∞–Ω—è" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –≤—Å–µ—Ö —Å–ª–æ—Ç–æ–≤.

–ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤:
- –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ "–∑–∞–≤—Ç—Ä–∞" - –∏—Å–ø–æ–ª—å–∑—É–π –∑–∞–≤—Ç—Ä–∞—à–Ω—é—é –¥–∞—Ç—É
- –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ "–≤—Ç–æ—Ä–Ω–∏–∫ 29" - —ç—Ç–æ 29 –∏—é–ª—è 2025
- –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ "—Å—Ä–µ–¥–∞" –±–µ–∑ –¥–∞—Ç—ã - —ç—Ç–æ –±–ª–∏–∂–∞–π—à–∞—è —Å—Ä–µ–¥–∞
- –í—Ä–µ–º—è –≤—Å–µ–≥–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM
- –ï—Å–ª–∏ —Å–∫–∞–∑–∞–Ω–æ "–Ω–∞ —á–∞—Å" –∏–ª–∏ "–Ω–∞ 90 –º–∏–Ω—É—Ç", —Ä–∞—Å—Å—á–∏—Ç–∞–π –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (—Å—Ç—Ä–æ–≥–æ JSON):
{{
  "name": "–∏–º—è –∏–ª–∏ null",
  "services": ["—Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥"],
  "time_slots": [
    {{
      "date": "YYYY-MM-DD",
      "start_time": "HH:MM",
      "end_time": "HH:MM",
      "location": "–ë–∞–Ω—è (–∏–ª–∏ –¥—Ä—É–≥–∞—è –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞)"
    }}
  ],
  "locations": ["–ë–∞–Ω—è"]
}}

–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.
"""
        
        try:
            # –§—É–Ω–∫—Ü–∏—è –¥–ª—è retry
            def make_request():
                return self.client.chat.completions.create(
                    model="gpt-4",
                    messages=[
                        {"role": "system", "content": "–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON."},
                        {"role": "user", "content": prompt}
                    ],
                    temperature=0.1,
                    timeout=30.0
                )
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π retry –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            max_retries = 3
            last_error = None
            
            for attempt in range(max_retries):
                try:
                    response = make_request()
                    break
                except openai.RateLimitError as e:
                    last_error = e
                    if attempt == max_retries - 1:
                        raise
                    import time
                    wait_time = 2 ** attempt
                    logger.warning(f"Rate limited, waiting {wait_time}s (attempt {attempt + 1})")
                    time.sleep(wait_time)
                except (openai.APIConnectionError, openai.APITimeoutError) as e:
                    last_error = e
                    if attempt == max_retries - 1:
                        raise
                    import time
                    wait_time = 2 ** attempt
                    logger.warning(f"API connection error, retrying in {wait_time}s (attempt {attempt + 1})")
                    time.sleep(wait_time)
                except Exception as e:
                    logger.error(f"OpenAI API error: {e}")
                    raise
            
            result_text = response.choices[0].message.content.strip()
            
            # –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            try:
                result = json.loads(result_text)
            except json.JSONDecodeError:
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å, –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ JSON –≤ —Ç–µ–∫—Å—Ç–µ
                json_match = re.search(r'\{.*\}', result_text, re.DOTALL)
                if json_match:
                    result = json.loads(json_match.group())
                else:
                    raise ValueError("GPT –Ω–µ –≤–µ—Ä–Ω—É–ª –≤–∞–ª–∏–¥–Ω—ã–π JSON")
            
            logger.info(f"GPT —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –∞–Ω–∫–µ—Ç—É: {result}")
            return result
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∞–Ω–∫–µ—Ç—ã —Å GPT: {e}")
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            return {
                "name": None,
                "services": ["–º–∞—Å—Å–∞–∂"],
                "time_slots": [],
                "locations": ["–±–∞–Ω—è"]
            }
    
    def create_fantasy_description(self, original_text: str, extracted_data: Dict) -> str:
        """
        –°–æ–∑–¥–∞–µ—Ç —Ñ—ç–Ω—Ç–µ–∑–∏-–æ–ø–∏—Å–∞–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞ –≤ —Å—Ç–∏–ª–µ –º—É–¥—Ä–æ–≥–æ –û—Å—å–º–∏–Ω–æ–≥–∞.
        
        Args:
            original_text: –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –∞–Ω–∫–µ—Ç—ã
            extracted_data: –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            
        Returns:
            –§—ç–Ω—Ç–µ–∑–∏-–æ–ø–∏—Å–∞–Ω–∏–µ
        """
        
        name = extracted_data.get("name", "–¢–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –º–∞—Å—Ç–µ—Ä")
        services = ", ".join(extracted_data.get("services", ["—Ü–µ–ª–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏"]))
        locations = ", ".join(extracted_data.get("locations", ["–∑–∞–ø–æ–≤–µ–¥–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö"]))
        
        prompt = f"""
–ü–µ—Ä–µ–ø–∏—à–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞ –≤ —Å—Ç–∏–ª–µ –º—É–¥—Ä–æ–≥–æ –û—Å—å–º–∏–Ω–æ–≥–∞ - —Ö—Ä–∞–Ω–∏—Ç–µ–ª—è –∑–∞–ø–æ–≤–µ–¥–Ω–∏–∫–∞. 

–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:
"{original_text}"

–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
- –ò–º—è: {name}
- –£—Å–ª—É–≥–∏: {services}
- –õ–æ–∫–∞—Ü–∏–∏: {locations}

–°–æ–∑–¥–∞–π –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª–∏–Ω–æ–π 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ:
1. –°–¢–†–û–ì–û –°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢ —Ä–µ–∞–ª—å–Ω—ã–º –ø—Ä–∞–∫—Ç–∏–∫–∞–º –∏ –æ–ø—ã—Ç—É –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
2. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –í–°–ï –≤–∞–∂–Ω—ã–µ —Ñ–∞–∫—Ç—ã –æ –º–∞—Å—Ç–µ—Ä–µ (–æ–ø—ã—Ç, –æ–±—É—á–µ–Ω–∏–µ, —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏)
3. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∏–ª—å –∑–∞–ø–æ–≤–µ–¥–Ω–∏–∫–∞, –Ω–æ –ë–ï–ó –ü–†–ò–î–£–ú–´–í–ê–ù–ò–Ø –Ω–æ–≤—ã—Ö —Ñ–∞–∫—Ç–æ–≤
4. –ó–≤—É—á–∏—Ç —Ç–µ–ø–ª–æ –∏ –∑–∞–≥–∞–¥–æ—á–Ω–æ, –Ω–æ –æ—Å—Ç–∞–µ—Ç—Å—è –§–ê–ö–¢–ò–ß–ï–°–ö–ò –¢–û–ß–ù–´–ú

–ü–†–ê–í–ò–õ–ê:
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ
- –ù–ï –∏–∑–º–µ–Ω—è–π —Ä–µ–∞–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç—ã –æ–± –æ–±—É—á–µ–Ω–∏–∏ –∏–ª–∏ –æ–ø—ã—Ç–µ
- –°–û–•–†–ê–ù–Ø–ô –≤—Å–µ —É–ø–æ–º—è–Ω—É—Ç—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –∏ –ø–æ–¥—Ö–æ–¥—ã
- –ú–æ–∂–µ—à—å —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –∑–∞–ø–æ–≤–µ–¥–Ω–∏–∫–∞ –∫ –†–ï–ê–õ–¨–ù–´–ú —Ñ–∞–∫—Ç–∞–º

–ü—Ä–∏–º–µ—Ä—ã –ü–†–ê–í–ò–õ–¨–ù–û–ì–û —Å—Ç–∏–ª—è:
- "–í –≥–ª—É–±–∏–Ω–∞—Ö –∑–∞–ø–æ–≤–µ–¥–Ω–∏–∫–∞ –º–∞—Å—Ç–µ—Ä {name}, –∏–∑—É—á–∏–≤—à–∏–π [—Ä–µ–∞–ª—å–Ω—É—é —Ç–µ—Ö–Ω–∏–∫—É], –ø–æ–º–æ–≥–∞–µ—Ç..."
- "–ü—Ä–æ–π–¥—è –æ–±—É—á–µ–Ω–∏–µ [–≥–¥–µ —Ä–µ–∞–ª—å–Ω–æ —É—á–∏–ª—Å—è], —Ç–µ–ø–µ—Ä—å –≤ —Ç—ë–ø–ª—ã—Ö –≤–æ–¥–∞—Ö –±–∞–Ω–∏..."

–ü–∏—à–∏ –æ—Ç —Ç—Ä–µ—Ç—å–µ–≥–æ –ª–∏—Ü–∞, –ë–ï–ó –≤—ã–¥—É–º–æ–∫.
"""
        
        try:
            response = self.client.chat.completions.create(
                model="gpt-4",
                messages=[
                    {"role": "system", "content": "–¢—ã –º—É–¥—Ä—ã–π –û—Å—å–º–∏–Ω–æ–≥, —Ö—Ä–∞–Ω–∏—Ç–µ–ª—å –∑–∞–ø–æ–≤–µ–¥–Ω–∏–∫–∞. –ì–æ–≤–æ—Ä–∏ –∑–∞–≥–∞–¥–æ—á–Ω–æ, –Ω–æ —Ç–µ–ø–ª–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É."},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.3,  # –°–Ω–∏–∂–µ–Ω–∞ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
                max_tokens=250
            )
            
            result = response.choices[0].message.content.strip()
            logger.info(f"GPT —Å–æ–∑–¥–∞–ª —Ñ—ç–Ω—Ç–µ–∑–∏-–æ–ø–∏—Å–∞–Ω–∏–µ: {result}")
            return result
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ñ—ç–Ω—Ç–µ–∑–∏-–æ–ø–∏—Å–∞–Ω–∏—è: {e}")
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            return f"–í —Ç—ë–ø–ª—ã—Ö –≥–ª—É–±–∏–Ω–∞—Ö –∑–∞–ø–æ–≤–µ–¥–Ω–∏–∫–∞ {name} –¥–µ–ª–∏—Ç—Å—è –¥—Ä–µ–≤–Ω–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ {services}. –ï–≥–æ –º—É–¥—Ä—ã–µ —Ä—É–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç –ø—É—Ç—å –∫ –∏—Å—Ü–µ–ª–µ–Ω–∏—é –≤ {locations}."
    
    def parse_time_slots(self, slots_text: str) -> List[Dict]:
        """
        –ü–∞—Ä—Å–∏—Ç —Ç–µ–∫—Å—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
        
        Args:
            slots_text: –¢–µ–∫—Å—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å–ª–æ—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–∑–∞–≤—Ç—Ä–∞ —Å 14 –¥–æ 18 –≤ –±–∞–Ω–µ, –∫–∞–∂–¥—ã–π —Å–ª–æ—Ç –ø–æ 1 —á–∞—Å—É —Å –ø–µ—Ä–µ—Ä—ã–≤–æ–º –ø–æ 10 –º–∏–Ω—É—Ç –º–µ–∂–¥—É —Å–ª–æ—Ç–∞–º–∏")
            
        Returns:
            –°–ø–∏—Å–æ–∫ —Å–ª–æ—Ç–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ [{"date": "2025-08-02", "start_time": "14:00", "end_time": "15:00", "location": "–±–∞–Ω—è"}]
        """
        
        prompt = f"""
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—Å—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –¥–ª—è –º–∞—Å—Å–∞–∂–∏—Å—Ç–∞ –∏ –≤–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON –º–∞—Å—Å–∏–≤.

–¢–µ–∫—Å—Ç: "{slots_text}"

–ü—Ä–∞–≤–∏–ª–∞:
1. –°–µ–≥–æ–¥–Ω—è: 1 –∞–≤–≥—É—Å—Ç–∞ 2025 –≥–æ–¥–∞, —á–µ—Ç–≤–µ—Ä–≥
2. "–ó–∞–≤—Ç—Ä–∞" = 2 –∞–≤–≥—É—Å—Ç–∞ 2025 (–ø—è—Ç–Ω–∏—Ü–∞)
3. "–ü–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞" = 3 –∞–≤–≥—É—Å—Ç–∞ 2025 (—Å—É–±–±–æ—Ç–∞)  
4. "–í –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫" = –±–ª–∏–∂–∞–π—à–∏–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ (4 –∞–≤–≥—É—Å—Ç–∞ 2025)
5. "–í —Å—É–±–±–æ—Ç—É" = –±–ª–∏–∂–∞–π—à–∞—è —Å—É–±–±–æ—Ç–∞ (2 –∞–≤–≥—É—Å—Ç–∞ 2025, –µ—Å–ª–∏ –µ—â–µ –Ω–µ –ø—Ä–æ—à–ª–∞, –∏–Ω–∞—á–µ —Å–ª–µ–¥—É—é—â–∞—è)

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ - –º–∞—Å—Å–∏–≤ JSON –æ–±—ä–µ–∫—Ç–æ–≤:
[
  {{
    "date": "2025-08-02",
    "start_time": "14:00", 
    "end_time": "15:00",
    "location": "–ë–∞–Ω—è",
    "duration_minutes": 60
  }}
]

–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –¥–∏–∞–ø–∞–∑–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä "—Å 14 –¥–æ 18") –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–ª–æ—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä "–ø–æ —á–∞—Å—É"), —Å–æ–∑–¥–∞–π –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–ª–æ—Ç—ã.
–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –ø–µ—Ä–µ—Ä—ã–≤ –º–µ–∂–¥—É —Å–ª–æ—Ç–∞–º–∏, —É—á—Ç–∏ –µ–≥–æ.

–í–ê–ñ–ù–û: –ï—Å–ª–∏ –ª–æ–∫–∞—Ü–∏—è –ù–ï —É–∫–∞–∑–∞–Ω–∞ —è–≤–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–π "–ë–∞–Ω—è" –¥–ª—è –≤—Å–µ—Ö —Å–ª–æ—Ç–æ–≤.

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON –º–∞—Å—Å–∏–≤, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.
"""

        try:
            logger.info(f"–ù–∞—á–∏–Ω–∞—é –ø–∞—Ä—Å–∏–Ω–≥ —Å–ª–æ—Ç–æ–≤: {slots_text}")
            
            response = self.client.chat.completions.create(
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                temperature=0.1
            )
            
            response_text = response.choices[0].message.content.strip()
            
            # –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
            if response_text.startswith("```"):
                response_text = response_text.split("```")[1]
                if response_text.startswith("json"):
                    response_text = response_text[4:]
            
            # –ü–∞—Ä—Å–∏–º JSON
            slots = json.loads(response_text)
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
            valid_slots = []
            for slot in slots:
                if all(key in slot for key in ["date", "start_time", "end_time", "location"]):
                    valid_slots.append(slot)
                    
            logger.info(f"–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ {len(valid_slots)} —Å–ª–æ—Ç–æ–≤ –∏–∑ —Ç–µ–∫—Å—Ç–∞: {slots_text}")
            return valid_slots
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ —Å–ª–æ—Ç–æ–≤ —Å GPT: {e}")
            return []

    def process_master_profile(self, profile_text: str) -> Tuple[Dict, str]:
        """
        –ü–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞–Ω–∫–µ—Ç—ã –º–∞—Å—Ç–µ—Ä–∞: –∞–Ω–∞–ª–∏–∑ + —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ—ç–Ω—Ç–µ–∑–∏-–æ–ø–∏—Å–∞–Ω–∏—è.
        
        Args:
            profile_text: –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –∞–Ω–∫–µ—Ç—ã
            
        Returns:
            Tuple (extracted_data, fantasy_description)
        """
        
        logger.info("–ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É –∞–Ω–∫–µ—Ç—ã –º–∞—Å—Ç–µ—Ä–∞...")
        
        # –°–Ω–∞—á–∞–ª–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        extracted_data = self.analyze_master_profile(profile_text)
        
        # –ó–∞—Ç–µ–º —Å–æ–∑–¥–∞–µ–º —Ñ—ç–Ω—Ç–µ–∑–∏-–æ–ø–∏—Å–∞–Ω–∏–µ
        fantasy_description = self.create_fantasy_description(profile_text, extracted_data)
        
        logger.info("–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–Ω–∫–µ—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
        return extracted_data, fantasy_description
    
    def generate_personalized_reminder(self, is_master: bool, master_name: str, client_name: str, 
                                     slot_time: str, slot_location: str, reminder_type: str) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ —Å—Ç–∏–ª–µ –ú—è—Ç–Ω–æ–≥–æ –ó–∞–ø–æ–≤–µ–¥–Ω–∏–∫–∞.
        
        Args:
            is_master: –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞ (True) –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞ (False)
            master_name: –ò–º—è –º–∞—Å—Ç–µ—Ä–∞
            client_name: –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞  
            slot_time: –í—Ä–µ–º—è —Å–µ–∞–Ω—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "14:00-15:00")
            slot_location: –õ–æ–∫–∞—Ü–∏—è —Å–µ–∞–Ω—Å–∞
            reminder_type: –¢–∏–ø –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è ("1_hour" –∏–ª–∏ "15_min")
            
        Returns:
            –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
        """
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
        time_context = "—á–µ—Ä–µ–∑ —á–∞—Å" if reminder_type == "1_hour" else "—á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç"
        urgency = "–≥–æ—Ç–æ–≤—å—Å—è" if reminder_type == "1_hour" else "–ø–æ—Ä–∞!"
        
        # –†–∞–∑–ª–∏—á–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞ –∏ –∫–ª–∏–µ–Ω—Ç–∞
        if is_master:
            role_context = f"–¢—ã –Ω–∞–ø–æ–º–∏–Ω–∞–µ—à—å –º–∞—Å—Ç–µ—Ä—É {master_name} –æ –ø—Ä–µ–¥—Å—Ç–æ—è—â–µ–º —Å–µ–∞–Ω—Å–µ —Å –∫–ª–∏–µ–Ω—Ç–æ–º {client_name}"
            role_details = "–ú–∞—Å—Ç–µ—Ä –¥–æ–ª–∂–µ–Ω –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è: –≤–∑—è—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é, –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å—Å—è –Ω–∞ —Ä–∞–±–æ—Ç—É"
        else:
            role_context = f"–¢—ã –Ω–∞–ø–æ–º–∏–Ω–∞–µ—à—å –∫–ª–∏–µ–Ω—Ç—É {client_name} –æ –ø—Ä–µ–¥—Å—Ç–æ—è—â–µ–º –º–∞—Å—Å–∞–∂–µ —É –º–∞—Å—Ç–µ—Ä–∞ {master_name}"
            role_details = "–ö–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–π—Ç–∏ –≤–æ–≤—Ä–µ–º—è, –≤–æ–∑–º–æ–∂–Ω–æ –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –ø–æ–ª–æ—Ç–µ–Ω—Ü–µ, —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å—Å—è –Ω–∞ —Å–µ–∞–Ω—Å"
        
        prompt = f"""
–¢—ã - –¥—É—Ö –ú—è—Ç–Ω–æ–≥–æ –ó–∞–ø–æ–≤–µ–¥–Ω–∏–∫–∞, –≤–æ–ª—à–µ–±–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –∏—Å—Ü–µ–ª–µ–Ω–∏—è –∏ –≥–∞—Ä–º–æ–Ω–∏–∏. üêôüåä

–ó–ê–î–ê–ß–ê: –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –º–∞—Å—Å–∞–∂–µ {time_context}.

–ö–û–ù–¢–ï–ö–°–¢:
‚Ä¢ {role_context}
‚Ä¢ –í—Ä–µ–º—è —Å–µ–∞–Ω—Å–∞: {slot_time}  
‚Ä¢ –õ–æ–∫–∞—Ü–∏—è: {slot_location}
‚Ä¢ –°—Ç–µ–ø–µ–Ω—å —Å—Ä–æ—á–Ω–æ—Å—Ç–∏: {urgency}
‚Ä¢ {role_details}

–°–¢–ò–õ–¨ –ù–ê–ü–ò–°–ê–ù–ò–Ø:
‚Ä¢ –ú–∏—Å—Ç–∏—á–µ—Å–∫–∏–π, –Ω–æ —Ç—ë–ø–ª—ã–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π –æ–±—Ä–∞–∑—ã –≤–æ–¥—ã, –≥–ª—É–±–∏–Ω, –∏—Å—Ü–µ–ª–µ–Ω–∏—è, –ø—Ä–∏—Ä–æ–¥—ã
‚Ä¢ –î–æ–±–∞–≤–ª—è–π —ç–º–æ–¥–∑–∏ –æ–∫–µ–∞–Ω–∞/–º–∏—Å—Ç–∏–∫–∏: üêôüåäüí´‚ú®üåø
‚Ä¢ –¢–æ–Ω –≤–µ—Å–µ–ª—ã–π, –Ω–æ –∑–∞–±–æ—Ç–ª–∏–≤—ã–π
‚Ä¢ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º
‚Ä¢ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–ø–æ–º—è–Ω–∏ –≤—Ä–µ–º—è, –º–µ—Å—Ç–æ –∏ –∏–º–µ–Ω–∞

–ü–†–ò–ú–ï–†–´ –ú–ò–°–¢–ò–ß–ï–°–ö–ò–• –§–†–ê–ó:
‚Ä¢ "–ì–ª—É–±–∏–Ω—ã –∑–∞–ø–æ–≤–µ–¥–Ω–∏–∫–∞ –Ω–∞—à–µ–ø—Ç—ã–≤–∞—é—Ç..."
‚Ä¢ "–¢–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ—Å—É—Ç –≤–µ—Å—Ç—å..."  
‚Ä¢ "–ú—è—Ç–Ω—ã–µ –≤–æ–ª–Ω—ã –Ω–∞–ø–æ–º–∏–Ω–∞—é—Ç..."
‚Ä¢ "–î—É—Ö–∏ –∑–∞–ø–æ–≤–µ–¥–Ω–∏–∫–∞ —à–µ–ø—á—É—Ç..."
‚Ä¢ "–ò—Å—Ü–µ–ª—è—é—â–∏–µ –≤–æ–¥—ã –∑–æ–≤—É—Ç..."

–°–æ–∑–¥–∞–π –ü–ï–†–°–û–ù–ê–õ–¨–ù–û–ï –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:
"""

        try:
            logger.info(f"–ì–µ–Ω–µ—Ä–∏—Ä—É—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ {reminder_type} –¥–ª—è {'–º–∞—Å—Ç–µ—Ä–∞' if is_master else '–∫–ª–∏–µ–Ω—Ç–∞'}")
            
            response = self.client.chat.completions.create(
                model=GPT_MODEL,
                messages=[
                    {"role": "system", "content": "–¢—ã - –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –¥—É—Ö –ú—è—Ç–Ω–æ–≥–æ –ó–∞–ø–æ–≤–µ–¥–Ω–∏–∫–∞, —Å–æ–∑–¥–∞—é—â–∏–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –º–∞—Å—Å–∞–∂–∞—Ö."},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=200,
                temperature=0.8
            )
            
            reminder = response.choices[0].message.content.strip()
            logger.info("–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ")
            return reminder
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: {e}")
            
            # Fallback —Ç–µ–∫—Å—Ç
            if is_master:
                return f"üêô {master_name}, —á–µ—Ä–µ–∑ {time_context.replace('—á–µ—Ä–µ–∑ ', '')} —Ç–≤–æ–π —Å–µ–∞–Ω—Å —Å {client_name} –≤ {slot_location} ({slot_time}). –ì–ª—É–±–∏–Ω—ã –∑–∞–ø–æ–≤–µ–¥–Ω–∏–∫–∞ –∂–¥—É—Ç —Ç–≤–æ–µ–≥–æ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞! ‚ú®"
            else:
                return f"üåä {client_name}, —á–µ—Ä–µ–∑ {time_context.replace('—á–µ—Ä–µ–∑ ', '')} —Ç–≤–æ–π –º–∞—Å—Å–∞–∂ —É {master_name} –≤ {slot_location} ({slot_time}). –ò—Å—Ü–µ–ª—è—é—â–∏–µ –≤–æ–¥—ã –∑–æ–≤—É—Ç —Ç–µ–±—è! üí´"